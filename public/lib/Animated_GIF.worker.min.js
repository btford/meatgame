function NeuQuant(){function r(r,n,a){var t,f;for(v=r,p=n,h=a,l=new Array(y),t=0;y>t;t++)l[t]=new Array(4),f=l[t],f[0]=f[1]=f[2]=(t<<Q+8)/y|0,P[t]=j/y|0,L[t]=0}function n(){for(var r=[],n=new Array(y),a=0;y>a;a++)n[l[a][3]]=a;for(var t=0,f=0;y>f;f++){var o=n[f];r[t++]=l[o][0],r[t++]=l[o][1],r[t++]=l[o][2]}return r}function a(){var r,n,a,t,f,o,e,u;for(e=0,u=0,r=0;y>r;r++){for(f=l[r],a=r,t=f[1],n=r+1;y>n;n++)o=l[n],o[1]<t&&(a=n,t=o[1]);if(o=l[a],r!=a&&(n=o[0],o[0]=f[0],f[0]=n,n=o[1],o[1]=f[1],f[1]=n,n=o[2],o[2]=f[2],f[2]=n,n=o[3],o[3]=f[3],f[3]=n),t!=e){for(K[e]=u+r>>1,n=e+1;t>n;n++)K[n]=r;e=t,u=r}}for(K[e]=u+N>>1,n=e+1;256>n;n++)K[n]=N}function t(){var r,n,a,t,f,o,e,l,y,N,b,j,k,x;for(d>p&&(h=1),s=30+(h-1)/3,j=v,k=0,x=p,b=p/(3*h),N=b/U|0,l=E,o=B,e=o>>q,1>=e&&(e=0),r=0;e>r;r++)R[r]=l*((e*e-r*r)*G/(e*e));for(y=d>p?3:p%g!==0?3*g:p%w!==0?3*w:p%m!==0?3*m:3*A,r=0;b>r;)if(a=(255&j[k+0])<<Q,t=(255&j[k+1])<<Q,f=(255&j[k+2])<<Q,n=c(a,t,f),i(l,n,a,t,f),0!==e&&u(e,n,a,t,f),k+=y,k>=x&&(k-=p),r++,0===N&&(N=1),r%N===0)for(l-=l/s,o-=o/C,e=o>>q,1>=e&&(e=0),n=0;e>n;n++)R[n]=l*((e*e-n*n)*G/(e*e))}function f(r,n,a){var t,f,o,e,u,i,c;for(u=1e3,c=-1,t=K[n],f=t-1;y>t||f>=0;)y>t&&(i=l[t],o=i[1]-n,o>=u?t=y:(t++,0>o&&(o=-o),e=i[0]-r,0>e&&(e=-e),o+=e,u>o&&(e=i[2]-a,0>e&&(e=-e),o+=e,u>o&&(u=o,c=i[3])))),f>=0&&(i=l[f],o=n-i[1],o>=u?f=-1:(f--,0>o&&(o=-o),e=i[0]-r,0>e&&(e=-e),o+=e,u>o&&(e=i[2]-a,0>e&&(e=-e),o+=e,u>o&&(u=o,c=i[3]))));return c}function o(){return t(),e(),a(),n()}function e(){var r;for(r=0;y>r;r++)l[r][0]>>=Q,l[r][1]>>=Q,l[r][2]>>=Q,l[r][3]=r}function u(r,n,a,t,f){var o,e,u,i,c,s,v;for(u=n-r,-1>u&&(u=-1),i=n+r,i>y&&(i=y),o=n+1,e=n-1,s=1;i>o||e>u;){if(c=R[s++],i>o){v=l[o++];try{v[0]-=c*(v[0]-a)/J|0,v[1]-=c*(v[1]-t)/J|0,v[2]-=c*(v[2]-f)/J|0}catch(p){}}if(e>u){v=l[e--];try{v[0]-=c*(v[0]-a)/J|0,v[1]-=c*(v[1]-t)/J|0,v[2]-=c*(v[2]-f)/J|0}catch(p){}}}}function i(r,n,a,t,f){var o=l[n],e=r/E;o[0]-=e*(o[0]-a)|0,o[1]-=e*(o[1]-t)|0,o[2]-=e*(o[2]-f)|0}function c(r,n,a){var t,f,o,e,u,i,c,s,v,p;for(s=~(1<<31),v=s,i=-1,c=i,t=0;y>t;t++)p=l[t],f=p[0]-r,0>f&&(f=-f),o=p[1]-n,0>o&&(o=-o),f+=o,o=p[2]-a,0>o&&(o=-o),f+=o,s>f&&(s=f,i=t),e=f-(L[t]>>b-Q),v>e&&(v=e,c=t),u=P[t]>>x,P[t]-=u,L[t]+=u<<k;return P[i]+=I,L[i]-=M,c}var s,v,p,h,l,y=256,g=499,w=491,m=487,A=503,d=3*A,N=y-1,Q=4,U=100,b=16,j=1<<b,k=10,x=10,I=j>>x,M=j<<k-x,O=y>>3,q=6,z=1<<q,B=O*z,C=30,D=10,E=1<<D,F=8,G=1<<F,H=D+F,J=1<<H,K=[],L=[],P=[],R=[];r.apply(this,arguments);var S={};return S.map=f,S.process=o,S}function run(r){for(var n,a,t,f=r.data,o=Object.keys(f).length,e=o/4,u=r.sampleInterval,i=[],c=0,s=new Uint8Array(e);o>c;)n=f[c++],a=f[c++],t=f[c++],i.push(t),i.push(a),i.push(n),c++;for(var v=new NeuQuant(i,i.length,u),p=v.process(),h=[],l=0;l<p.length;l+=3)t=p[l],a=p[l+1],n=p[l+2],h.push(n<<16|a<<8|t);for(var y=new Uint32Array(h),g=0,w=0;e>w;w++){t=i[g++],a=i[g++],n=i[g++];var m=v.map(t,a,n);s[w]=m}return{pixels:s,palette:y}}self.onmessage=function(r){var n=r.data,a=run(n);postMessage(a)};